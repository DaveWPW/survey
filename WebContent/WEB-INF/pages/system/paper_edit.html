<!-- Horizontal Form -->
<div class="box box-info">
  <div class="box-header with-border">
    <h3 class="box-title">问卷编辑页面</h3>
    <div class="box-tools">
	  <div class="input-group input-group-sm" style="width: 100px;">
		<button type="button" class="btn btn-default btn-select-ques">添加问题</button>
	  </div>
	</div>
  </div>
</div>
<!-- /.box-header -->
<!-- form start -->
<form class="form-horizontal">
  <div id="dbody" class="box-body">
  	<div class="form-group">
      <label for="paperName" class="col-sm-2 control-label">问卷名称:</label>
      <div class="col-sm-10">
      	<input type="text" id="paperName" style="width: 60%;" placeholder="请用英文和数字命名">
      	<input type="radio" name="paperLanguage" value="eng">英文 
      	<input type="radio" name="paperLanguage" value="ch">中文 
      </div>
    </div>
    <div class="form-group">
      <label for="paperTitle" class="col-sm-2 control-label">问卷标题:</label>
      <div class="col-sm-10">
        <textarea id="paperTitle" style="width: 80%;height: 30%;"></textarea>
      </div>
    </div>
    <div class="form-group">
      <label for="greet" class="col-sm-2 control-label">欢迎内容:</label>
      <div class="col-sm-10">
        <textarea id="greet" style="width: 80%;height: 30%;"></textarea>
      </div>
    </div>
    <div id="quesDivs"></div>
    <div class="form-group">
      <label for="thank" class="col-sm-2 control-label">感谢内容:</label>
      <div class="col-sm-10">
        <textarea id="thank" style="width: 80%;height: 30%;"></textarea>
      </div>
    </div>
  </div>
  <!-- /.box-body -->
  <div class="box-footer">
    <button type="button" class="btn btn-default btn-cancel">Cancel</button>
    <button type="button" class="btn btn-info pull-right btn-save">Save</button>
  </div>
  <!-- /.box-footer -->
</form>
<script type="text/javascript" src="bower_components/layer/layer.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	doInitFormData();
	$(".box-tools").on("click", ".btn-select-ques", doSelectQuesUI);
	$(".box-footer")
		.on("click", ".btn-save", doSaveOrUpdate)
		.on("click", ".btn-cancel", doCancel);
	$("#quesDivs")
		.on("click", ".btn-delete", doDeleteQues)
		.on("click", ".btn-shiftup", doShiftUpQues)
		.on("click", ".btn-shiftdown", doShiftDownQues);
});
//跳转选择题目操作
function doSelectQuesUI(){
	$("#mainContentId").load("paper/doSelectQuesUI.do");
	$("#mainContentId").data("title", $(".box-title").html());
}
//刷新数据,重定向paper_list.html页面
function doCancel(){
	$("#mainContentId").removeData("paperData");
	$("#mainContentId").removeData("quesData");
	$("#mainContentId").removeData("ids");
	$("#mainContentId").removeData("title");
	$("#mainContentId").load("paper/doPaperListUI.do");
}
//删除后重置QuesIds
function doInitQuesIds(){
	$("#mainContentId").removeData("ids");
	var ids = [];
	$(".quesId").each(function(){
		if($(this).val() != null){
			ids.push($(this).val());
		}
	});
	$("#mainContentId").data("ids", ids.toString());
}
//删除问题操作
function doDeleteQues(){
	$(this).parent().parent().parent().remove();
	autoAddNumber();
	doInitQuesIds();
}
//上移操作
function doShiftUpQues(){
	var index = $(this).parent().parent().parent().index();
	if(index === 0){
		alert("已在最上面");
		return;
	}
	var arr = $("#quesDivs").find(".quesDiv").toArray();
	var temp;
    temp = arr[index];
    arr[index] = arr[index-1];
    arr[index-1] = temp;
    $("#quesDivs").html(arr);
    autoAddNumber();
}
//下移操作
function doShiftDownQues(){
	var index = $(this).parent().parent().parent().index();
	var arr = $("#quesDivs").find(".quesDiv").toArray();
	if(index === arr.length-1){
		alert("已在最下面");
		return;
	}
	var temp;
    temp = arr[index];
    arr[index] = arr[index+1];
    arr[index+1] = temp;
    $("#quesDivs").html(arr);
    autoAddNumber();
}
function doAddQuesName(quesId){
	var quesDivs = $("#quesDivs");
	var quesNameDiv =
		"<div class='quesDiv'>"+
			"<div class='form-group'>"+
    			"<label class='col-sm-2 control-label numberClass'></label>"+
    			"<div class='col-sm-10'>"+
    				"<input class='quesId' value='"+quesId+"' style='display:none;'/>"+
    				"<span class='quesName'></span>"+
    				"<button type='button' class='btn-delete'>删除</button>"+
    				"<button type='button' class='btn-shiftup'>上移</button>"+
    				"<button type='button' class='btn-shiftdown'>下移</button>"+
    			"</div>"+
    		"</div>"+
    	"</div>";
    quesDivs.append(quesNameDiv);
}
function doAddOption(options, optionId, type, quesDiv){
	if(type === "01"){
		var optionDiv = 
			"<div class='form-group'>"+
				"<label class='col-sm-2 control-label'></label>"+
				"<div class='col-sm-10'>"+
				"<input type='radio' class='optionId' value='"+optionId+"'><span class='optionContent'>"+options+"</span>"+
				"</div>"+
			"</div>";
		quesDiv.append(optionDiv);
	}else if(type === "02"){
		var optionDiv = 
			"<div class='form-group'>"+
				"<label class='col-sm-2 control-label'></label>"+
				"<div class='col-sm-10'>"+
					"<input type='checkbox' class='optionId' value='"+optionId+"'><span class='optionContent'>"+options+"</span>"+
				"</div>"+
			"</div>";
		quesDiv.append(optionDiv);
	}
}
function doAddEsay(quesDiv){
	var optionDiv = 
		"<div class='form-group'>"+
			"<label class='col-sm-2 control-label'></label>"+
			"<div class='col-sm-10'>"+
				"<textarea class='esayResponse' style='width: 50%;height: 30%;'></textarea>"+
			"</div>"+
		"</div>";
	quesDiv.append(optionDiv);
}
function doInitFormData(){
	doInitQuesDate();
	doInitPaperDate();
}
function doInitQuesDate(){
	//创建问卷时获取问题后的Data数据
	var data = $("#mainContentId").data("quesData");
	//console.log(data);
	if(!data){
		return;
    }
	for(var a in data){
		var quesInfo = data[a];
		doAddQuesName(quesInfo.quesId);
		$(".quesName").eq(a).html(quesInfo.quesName);
		var quesDiv = $(".quesDiv").eq(a);
		debugger;
		for(var i = 0; i < quesInfo.options.length; i++){
			doAddOption(quesInfo.options[i], quesInfo.optionIds[i], quesInfo.quesType, quesDiv);
			if(quesInfo.flags[i] === 1){
				var input = "<input type='text' class='flag' style='width: 70%;'>";
				$("#quesDivs").find(".quesDiv").eq(a).find(".form-group").eq(i+1).find("div").eq(0).append(input);
			}
		}
		if(quesInfo.quesType === "03"){
			doAddEsay(quesDiv);
		}
	}
	autoAddNumber();
	var title = $("#mainContentId").data("title");
	$(".box-title").html(title);
}
//自增序列号
function autoAddNumber(){
	function number(){
	    var index = 0;
    	for(var i = 0;i < $(".numberClass").length; i++){
			$(".numberClass").get(index).innerHTML = i+1;
			index++;
    	}
	}
	number();
}
//添加文本框
function addTextBox(){
	
}
//保存和修改操作
function doSaveOrUpdate(){
	var data = $("#mainContentId").data("paperData");
	//console.log(data);
	//debugger;
	if(doValidated()){
		var params = getDataParam();
		if(data){
			params.paperId = data.paperId;
		}
		//console.log(params);
		var insertUrl = "paper/doAddPaper.do";
		var updateUrl = "paper/doUpdatePaper.do";
		var url = data ? updateUrl : insertUrl;
		$.post(url, params, function(result){
			if(result.state == 1){
				alert(result.message);
				doCancel();
			}else{
				alert(result.message);
			}
		});
	}
}
//获取需要的参数
function getDataParam(){
	var quesNum = [];
	$(".numberClass").each(function(){
		quesNum.push($(this).html());
	});
	var quesIds = [];
	$(".quesId").each(function(){
		quesIds.push($(this).val());
	});
	var type;
	if($(".box-title").html() === "创建单张问卷"){
		type = "01";
	}
	var params = {
		"paperName" : $("#paperName").val(),
		"paperType" : type,
		"paperLanguage" : doGetLanguage(),
		"quesNum" : quesNum.toString(),
		"quesIds" : quesIds.toString(),
		"paperTitle" : $("#paperTitle").val(),
		"greet" : $("#greet").val(),
		"thank" : $("#thank").val(),
	}
	return params;
}
function doGetLanguage(){
	return $("div input[name='paperLanguage']:checked").val();
}
//提交前校验
function doValidated(){
	var valid = true;
	if($(".quesId").length == 0){
		alert("问题数不能为0！！");
		valid = false;
	}
	if($("#paperName").val() == null || $("#paperName").val() == ""){
		alert("问卷名称不能为空！！");
		valid = false;
	}
	if(doGetLanguage() == null){
		alert("语言选择不能为空！！");
		valid = false;
	}
	if($("#paperTitle").val() == null || $("#paperTitle").val() == ""){
		alert("问卷标题不能为空！！");
		valid = false;
	}
	if($("#greet").val() == null || $("#greet").val() == ""){
		alert("欢迎内容不能为空！！");
		valid = false;
	}
	if($("#thank").val() == null || $("#thank").val() == ""){
		alert("感谢不能为空！！");
		valid = false;
	}
	return valid;
}

function doInitPaperDate(){
	//修改问卷时根据ID获取问卷的Data数据
	var data = $("#mainContentId").data("paperData");
	if(!data){
		return;
	}
	$("#paperName").val(data.paperName);
	$("#paperTitle").val(data.paperTitle);
	$("#greet").val(data.greet);
	$("#thank").val(data.thank);
	if(data.paperLanguage === "eng"){
		$("div input[name='paperLanguage']").eq(0).prop("checked", true);
	}else if(data.paperLanguage === "ch"){
		$("div input[name='paperLanguage']").eq(1).prop("checked", true);
	}
	var params = {"quesIds" : data.quesIds.toString()}
	var url = "paper/doSubmitQues.do";
	$.post(url, params, function(result){
		$("#mainContentId").data("quesData", result.data);
		doInitQuesDate();
	});
}
//console.log(ids.toString());
//alter(ids.toString());
//debugger;
</script>