<!-- Horizontal Form -->
 <div class="box box-info">
      <div class="box-header with-border">
        <h3 class="box-title">问卷编辑页面</h3>
      </div>
      <div>
        <button id="addQues" type="button" onclick="doSelectQuesUI()">选择问题添加</button>
      </div>
      <!-- /.box-header -->
      <!-- form start -->
      <form class="form-horizontal">
        <div id="dbody" class="box-body">
          <div class="form-group">
            <label for="paperName" class="col-sm-2 control-label">问卷标题:</label>
            <div class="col-sm-10">
              <textarea id="paperName" style="width: 80%;height: 30%;"></textarea>
            </div>
          </div>
          <div id="quesDivs"></div>
        </div>
        <!-- /.box-body -->
        <div class="box-footer">
          <button type="button" class="btn btn-default btn-cancel">Cancel</button>
          <button type="button" class="btn btn-info pull-right btn-save">Save</button>
        </div>
        <!-- /.box-footer -->
      </form>
    </div>
<script type="text/javascript" src="bower_components/layer/layer.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	doInitFormData();
	$(".box-footer")
		.on("click", ".btn-save", doSave)
		.on("click", ".btn-cancel", doCancel);
	$("#quesDivs")
		.on("click", ".btn-delete", doDeleteQues)
		.on("click", ".btn-shiftup", doShiftUpQues)
		.on("click", ".btn-shiftdown", doShiftDownQues);
});
//跳转选择题目操作
function doSelectQuesUI(){
	$("#mainContentId").load("paper/doSelectQuesUI.do");
	$("#mainContentId").data("title", $(".box-title").html());
}
//刷新数据,重定向paper_list.html页面
function doCancel(){
	$("#mainContentId").removeData("rowData");
	$("#mainContentId").removeData("ids");
	$("#mainContentId").removeData("title");
	$("#mainContentId").load("paper/doPaperListUI.do");
}
//删除后重置QuesIds
function doInitQuesIds(){
	$("#mainContentId").removeData("ids");
	var ids = [];
	$(".quesId").each(function(){
		if($(this).val() != null){
			ids.push($(this).val());
		}
	});
	$("#mainContentId").data("ids", ids.toString());
}
//删除问题操作
function doDeleteQues(){
	$(this).parent().parent().parent().remove();
	autoAddNumber();
	doInitQuesIds();
}
//上移操作
function doShiftUpQues(){
	var index = $(this).parent().parent().parent().index();
	if(index === 0){
		alert("已在最上面");
		return;
	}
	var arr = $("#quesDivs").find(".quesDiv").toArray();
	var temp;
    temp = arr[index];
    arr[index] = arr[index-1];
    arr[index-1] = temp;
    $("#quesDivs").html(arr);
    autoAddNumber();
}
//下移操作
function doShiftDownQues(){
	var index = $(this).parent().parent().parent().index();
	var arr = $("#quesDivs").find(".quesDiv").toArray();
	if(index === arr.length-1){
		alert("已在最下面");
		return;
	}
	var temp;
    temp = arr[index];
    arr[index] = arr[index+1];
    arr[index+1] = temp;
    $("#quesDivs").html(arr);
    autoAddNumber();
}
function doAddQuesName(quesId){
	var quesDivs = $("#quesDivs");
	var quesNameDiv =
		"<div class='quesDiv'>"+
			"<div class='form-group'>"+
    			"<label class='col-sm-2 control-label numberClass'></label>"+
    			"<div class='col-sm-10'>"+
    				"<input class='quesId' value='"+quesId+"' style='display:none;'/>"+
    				"<span class='quesName'></span>"+
    				"<button type='button' class='btn-delete'>删除</button>"+
    				"<button type='button' class='btn-shiftup'>上移</button>"+
    				"<button type='button' class='btn-shiftdown'>下移</button>"+
    			"</div>"+
    		"</div>"+
    	"</div>";
    quesDivs.append(quesNameDiv);
}
function doAddOption(options, optionId, type, quesDiv){
	if(type === "01"){
		var optionDiv = 
			"<div class='form-group'>"+
				"<label class='col-sm-2 control-label'></label>"+
				"<div class='col-sm-10'>"+
					"<span class='optionContent'>"+options+"</span>"+
				"</div>"+
			"</div>";
		quesDiv.append(optionDiv);
	}else if(type === "02"){
		var optionDiv = 
			"<div class='form-group'>"+
				"<label class='col-sm-2 control-label'></label>"+
				"<div class='col-sm-10'>"+
					"<input type='checkbox' class='optionId' value='"+optionId+"'><span class='optionContent'>"+options+"</span>"+
				"</div>"+
			"</div>";
		quesDiv.append(optionDiv);
	}
}
function doAddEsay(quesDiv){
	var optionDiv = 
		"<div class='form-group'>"+
			"<label class='col-sm-2 control-label'></label>"+
			"<div class='col-sm-10'>"+
				"<textarea class='esayResponse' style='width: 50%;height: 30%;'></textarea>"+
			"</div>"+
		"</div>";
	quesDiv.append(optionDiv);
}
function doInitFormData(){
	var data = $("#mainContentId").data("rowData");
	if(!data){
    	return;
    }
	for(var a in data){
		var quesInfo = data[a];
		doAddQuesName(quesInfo.quesId);
		$(".quesName").eq(a).html(quesInfo.quesName);
		var quesDiv = $(".quesDiv").eq(a);
		for(var i = 0; i < quesInfo.options.length; i++){
			doAddOption(quesInfo.options[i], quesInfo.optionIds[i], quesInfo.quesType, quesDiv);
		}
		if(quesInfo.quesType === "03"){
			doAddEsay(quesDiv);
		}
	}
	autoAddNumber();
	var title = $("#mainContentId").data("title");
	$(".box-title").html(title);
}
//自增序列号
function autoAddNumber(){
	function number(){
	    var index = 0;
    	for(var i = 0;i < $(".numberClass").length; i++){
			$(".numberClass").get(index).innerHTML = i+1;
			index++;
    	}
	}
	number();
}
//保存操作
function doSave(){
	if(doValidated()){
		var params = getDataParam();
		console.log(params);
		var url = "paper/doAddPaper.do";
		$.post(url, params, function(result){
			if(result.state == 1){
				alert(result.message);
				doCancel();
			}else{
				alert(result.message);
			}
		});
	}
}
//获取需要的参数
function getDataParam(){
	var quesNum = [];
	$(".numberClass").each(function(){
		console.log($(this).html());
		quesNum.push($(this).html());
	});
	var quesIds = [];
	$(".quesId").each(function(){
		console.log($(this).val());
		quesIds.push($(this).val());
	});
	var type;
	if($(".box-title").html() === "创建单张问卷"){
		type = "01";
	}
	var params = {
		"paperName" : $("#paperName").val(),
		"paperType" : type,
		"quesNum" : quesNum.toString(),
		"quesIds" : quesIds.toString(),
	}
	return params;
}
//提交前校验
function doValidated(){
	var valid = true;
	if($(".quesId").length == 0){
		alert("问题不能为空！！");
		valid = false;
	}
	if($("#paperName").val() == null || $("#paperName").val() == ""){
		alert("问卷标题不能为空！！");
		valid = false;
	}
	return valid;
}
//console.log(ids.toString());
//alter(ids.toString());
//debugger;
/* function getQuesData(){
	var options = [];
	$(".optionContent").each(function(){
		if($(this).val() != null){
			options.push($(this).val());
		}
	});
	var flags = [];
	$("#addOption input[type='checkbox").each(function(){
		if($(this).prop("checked")){
			flags.push(1);
		}else{
			flags.push(0);
		}
	});
	var type;
	var title = $(".box-title").html();
	if(title === "添加单选题" || title === "修改单选题"){
		type = "01";
	}else if(title === "添加多选题" || title === "修改多选题"){
		type = "02";
	}else if(title === "添加简答题" || title === "修改简答题"){
		type = "03";
	}
	var params = {
		"options" : options.toString(),
		"flags" : flags.toString(),
		"quesName" : $("#quesName").val(),
		"quesType" : type,
	}
	return params;
}
//添加和修改
function doAddOrUpdate(){
	var rowData = $("#mainContentId").data("rowData");
	var params = getQuesData();
	console.log(params);
	var insertUrl = "ques/doAddQues.do";
	var updateUrl = "ques/doUpdateQues.do";
	if(rowData){
		params.quesId = rowData.quesId;
	}
	console.log(params);
	var url = rowData ? updateUrl : insertUrl;
	$.post(url, params, function(result){
		if(result.state == 1){
			alert(result.message);
			doCancel();
		}else{
			alert(result.message);
		}
	})
} */
</script>