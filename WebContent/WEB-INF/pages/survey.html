<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>Survey</title>
</head>
<body>
  <input id="paperLanguage" type="hidden" th:value="${language}"/>
  <input id="paperName" type="hidden" th:value="${paperName}"/>
  <input id="mobile" type="hidden" th:value="${mobile}"/>
  <input id="cli" type="hidden" th:value="${cli}"/>
  <input id="agentId" type="hidden" th:value="${agentId}"/>
  <input id="startTime" type="hidden" th:value="${startTime}"/>
  <input id="url" type="hidden" th:value="${url}"/>
  <div id="paperDiv"></div>
</body>
<div class="box-button">
  <button type="button" class="btn-submit"></button>
</div>
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">
$(function(){
	doGetObjects();
	buttonStatus();
	$(".box-button").on("click",".btn-submit", doSubmit);
});
function doGetObjects(){
	//console.log("[[${language}]]");
	var url = "survey/doStartSurvey.do";
	var params = {
			"paperLanguage" : $("#paperLanguage").val(),
			"paperName" : $("#paperName").val(),
			}
	$.post(url, params, function(result){
		if(result.state == 1){
			doInitPaperDate(result.data);
			var params = {"quesIds" : result.data.quesIds.toString()}
			var url = "paper/doSubmitQues.do";
			$.post(url, params, function(result){
				doInitQuesDate(result.data);
			});
		}else{
			alert(result.message);
		}
	});
}
function doInitPaperDate(data){
	var paperDiv = $("#paperDiv");
	var paper =
		"<input id='paperId' style='display: none;' value='"+data.paperId+"'>"+
		"<input id='paperName' style='display: none;' value='"+data.paperName+"'>"+
		"<input id='paperType' style='display: none;' value='"+data.paperType+"'>"+
		"<div id='paperTitle'><h1>"+data.paperTitle+"</h1></div>"+
		"<div id='greet'><h2>"+data.greet+"</h2></div>"+
		"<div id='quesDivs'></div>"+
		"<div id='thank'><h2>"+data.thank+"</h2></div>";
	paperDiv.append(paper);
}
function doInitQuesDate(data){
	for(var a in data){
		var quesInfo = data[a];
		doAddQuesName(quesInfo.quesId, quesInfo.quesType);
		$(".quesName").eq(a).html(quesInfo.quesName);
		var quesDiv = $(".quesDiv").eq(a);
		for(var i = 0; i < quesInfo.options.length; i++){
			doAddOption(quesInfo.options[i], quesInfo.optionIds[i], quesInfo.quesType, quesDiv, quesInfo.quesId, quesInfo.flags[i]);
		}
		if(quesInfo.quesType === "03"){
			doAddEsay(quesDiv);
		}
	}
	autoAddNumber();
	$(".flag").each(function(){
		if($(this).val() == 1){
			$(this).show();//显示
			$(this).val("");
		}
	});
}
function doAddQuesName(quesId, quesType){
	var quesDivs = $("#quesDivs");
	var quesNameDiv =
		"<br/>"+
		"<div class='quesDiv'>"+
			"<div class='form-group'>"+
    			"<div>"+
    				"<label class='numberClass'></label><label>.</label>"+
    				"<input class='quesId' value='"+quesId+"' style='display:none;'/>"+
    				"<input class='quesType' value='"+quesType+"' style='display:none;'/>"+
    				"<span class='quesName'></span>"+
    			"</div>"+
    		"</div>"+
    	"</div>";
    quesDivs.append(quesNameDiv);
}
function doAddOption(optionCon, optionId, type, quesDiv, quesId, flag){
	if(type === "01"){
		var optionDiv = 
			"<div class='form-group'>"+
				"<div>"+
					"<input type='radio' class='optionId' name='optionName"+quesId+"' value='"+optionId+"'><span class='optionContent'>"+optionCon+"</span>"+
					"<input type='text' class='flag' value='"+flag+"' style='width: 20%; display:none;'>"+
				"</div>"+
			"</div>";
		quesDiv.append(optionDiv);
	}else if(type === "02"){
		var optionDiv = 
			"<div class='form-group'>"+
				"<div>"+
					"<input type='checkbox' class='optionId' value='"+optionId+"'><span class='optionContent'>"+optionCon+"</span>"+
					"<input type='text' class='flag' value='"+flag+"' style='width: 20%; display:none;'>"+
				"</div>"+
			"</div>";
		quesDiv.append(optionDiv);
	}
}
function doAddEsay(quesDiv){
	var optionDiv = 
		"<div class='form-group'>"+
			"<div>"+
				"<textarea class='esayResult' style='width: 50%;height: 30%;'></textarea>"+
			"</div>"+
		"</div>";
	quesDiv.append(optionDiv);
}
//自增序列号
function autoAddNumber(){
	function number(){
	    var index = 0;
    	for(var i = 0;i < $(".numberClass").length; i++){
			$(".numberClass").get(index).innerHTML = i+1;
			index++;
    	}
	}
	number();
}
function buttonStatus(){
	if($("#paperLanguage").val() === "ch"){
		$(".btn-submit").html("提交");
	}else if($("#paperLanguage").val() === "eng"){
		$(".btn-submit").html("Submit");
	}
}
function getSubmitData(){
	var params;
	var valid = true;
	var quesNums = [];
	var quesIds = [];
	var quesTypes = [];
	var optionCons = [];
	$(".quesDiv").each(function(){
		var num = $(this).find(".form-group").eq(0).find("div").eq(0).find(".numberClass").eq(0).html();
		console.log("num = "+num);
		var quesId = $(this).find(".form-group").eq(0).find("div").eq(0).find("input").eq(0).val();
		console.log("quesId = "+quesId);
		var quesType = $(this).find(".form-group").eq(0).find("div").eq(0).find("input").eq(1).val();
		if(quesType === "01"){
			var optionId = $("div input[name='optionName"+quesId+"']:checked").val();
			if(optionId == null || optionId == ""){
				alert("请为第"+num+"题选择！");
				valid = false;
				return;
			}
			console.log("optionId = "+optionId);
			var optionCon = $("div input[name='optionName"+quesId+"']:checked").parent().find(".optionContent").html();
			var flag = $("div input[name='optionName"+quesId+"']:checked").parent().find(".flag").val();
			if(flag == null || flag == ""){
				alert("请为第"+num+"题选项填写内容！");
				valid = false;
				return;
			}
			if(flag != 0){
				optionCon = optionCon + flag;
			}
			console.log("optionCon = "+optionCon);
			quesNums.push(num);
			quesIds.push(quesId);
			quesTypes.push(quesType);
			optionCons.push(optionCon);
		}else if(quesType === "02"){
			if($("div input[type='checkbox']:checked").length == 0){
				alert("请为第"+num+"题选择！");
				valid = false;
				return;
			}
			$("div input[type='checkbox']").each(function(){
				if($(this).prop("checked")){
					var optionCon = $(this).parent().find(".optionContent").html();
					var flag = $(this).parent().find(".flag").val();
					if(flag == null || flag == ""){
						alert("请为第"+num+"题选项填写内容！");
						valid = false;
						return;
					}
					if(flag != 0){
						optionCon = optionCon + flag;
					}
					console.log("optionCon = "+optionCon);
					quesNums.push(num);
					quesIds.push(quesId);
					quesTypes.push(quesType);
					optionCons.push(optionCon);
				}
			});
		}else if(quesType === "03"){
			var esayCon = $(this).find(".esayResult").val();
			console.log("esay = "+esayCon);
			if(esayCon == null || esayCon == ""){
				alert("请为第"+num+"题填写内容！");
				valid = false;
				return;
			}
			quesNums.push(num);
			quesIds.push(quesId);
			quesTypes.push(quesType);
			optionCons.push(esayCon);
		}
	});
	if(valid){
		params = {
			"mobileNum" : $("#mobile").val(),
			"cli" : $("#cli").val(),
			"agentId" : $("#agentId").val(),
			"paperId" : $("#paperId").val(),
			"paperType" : $("#paperType").val(),
			"paperLanguage" : $("#paperLanguage").val(),
			"startTime" : $("#startTime").val(),
			"quesNums" : quesNums.toString(),
			"quesIds" : quesIds.toString(),
			"quesTypes" : quesTypes.toString(),
			"optionCons" : optionCons.toString(),
			"url" : $("#url").val(),
		}
	}
	return params;
}
function doSubmit(){
	debugger;
	var params = getSubmitData();
	if(params){
		var url = "survey/doSubmitSurveyResult.do";
		$.post(url, params, function(result){
			if(result.state == 1){
				alert(result.message);
			}else{
				alert(result.message);
			}
		})
	}
}
//console.log();
//alert();
//debugger;
</script>
</html>